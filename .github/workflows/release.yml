name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag for the release (optional when triggering manually)"
        required: false

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            name: linux
          - os: windows-latest
            name: windows
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Create virtual environment
        run: |
          python -m venv .venv

      - name: Cache virtual environment
        uses: actions/cache@v4
        with:
          path: .venv
          key: ${{ runner.os }}-venv-${{ hashFiles('**/pyproject.toml', '**/requirements*.txt', '**/setup.py', '**/ai-proxy.spec') }}
          restore-keys: |
            ${{ runner.os }}-venv-

      - name: Install dependencies
        run: |
          # Activate virtual environment based on OS
          if [ "${{ runner.os }}" = "Windows" ]; then
            .venv\\Scripts\\activate
          else
            source .venv/bin/activate
          fi

          python -m pip install --upgrade pip

          # Install project dependencies if requirements file exists
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi

          pip install pyinstaller

      - name: Build with PyInstaller
        run: |
          # Activate virtual environment before building
          if [ "${{ runner.os }}" = "Windows" ]; then
            .venv\\Scripts\\activate
          else
            source .venv/bin/activate
          fi

          # Verify virtual environment is active
          which python
          python --version

          # List current directory contents
          echo "=== Current directory ==="
          if [ "${{ runner.os }}" = "Windows" ]; then
            dir
          else
            ls -la
          fi

          # Check if spec file exists
          echo "=== Checking spec file ==="
          if [ -f "ai-proxy.spec" ]; then
            echo "Found ai-proxy.spec"
          else
            echo "ai-proxy.spec not found"
            exit 1
          fi

          # Build with PyInstaller
          echo "=== Building with PyInstaller ==="
          pyinstaller --clean --distpath dist --workpath build ai-proxy.spec

          # Check build results
          echo "=== dist contents ==="
          if [ -d "dist" ]; then
            if [ "${{ runner.os }}" = "Windows" ]; then
              dir dist
            else
              ls -la dist
            fi
          else
            echo "dist directory not found"
          fi

          echo "=== build contents ==="
          if [ -d "build" ]; then
            if [ "${{ runner.os }}" = "Windows" ]; then
              dir build
            else
              ls -la build
            fi
          else
            echo "build directory not found"
          fi
        continue-on-error: false

      - name: Prepare artifact
        id: prepare_artifact
        shell: bash
        run: |
          # Use system Python for artifact preparation (not virtual environment)
          python - <<'PY'
          import os, shutil, sys, re

          # Determine tag name
          tag = os.environ.get('TAG', 'unknown')
          name = os.environ.get('MATRIX_NAME', 'unknown')

          # Validate tag format
          if not re.match(r'^v?\d+\.\d+\.\d+', tag) and tag not in ('unknown',):
              print(f"Warning: Tag '{tag}' doesn't match semantic versioning")

          artifact = f"ai-proxy-{tag}-{name}.zip"
          src = None

          # Find source directory
          for directory in ['dist', 'build']:
              if os.path.isdir(directory):
                  src = directory
                  break

          if not src:
              print('Error: No dist or build folder found', file=sys.stderr)
              sys.exit(1)

          # Create archive
          base_name = artifact.replace('.zip', '')
          shutil.make_archive(base_name, 'zip', src)

          if not os.path.exists(artifact):
              print(f'Error: Failed to create artifact {artifact}', file=sys.stderr)
              sys.exit(1)

          print(f"[OK] Created artifact: {artifact}")

          # Write to GitHub output
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"artifact={artifact}\n")
          PY
        env:
          TAG: ${{ github.ref_name || github.event.inputs.tag || github.run_number }}
          MATRIX_NAME: ${{ matrix.name }}
          PYTHONIOENCODING: utf-8

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.prepare_artifact.outputs.artifact }}
          path: ${{ steps.prepare_artifact.outputs.artifact }}

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name || github.event.inputs.tag }}
          name: Release ${{ github.ref_name || github.event.inputs.tag }}
          files: artifacts/**/*
          draft: false
          prerelease: false
          body: |
            Automated release created by GitHub Actions workflow

            ## Build Info
            - Build Date: ${{ github.event.head_commit.timestamp || 'N/A' }}
            - Commit: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
